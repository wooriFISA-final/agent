import os
import json
from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from pathlib import Path
from typing import TypedDict, Dict, Any
from langgraph.graph import StateGraph, END


# ============================================================
# 1ï¸âƒ£ LangGraph ìƒíƒœ ì •ì˜ (State)
# ============================================================
class FundAgentState(TypedDict):
    fund_data_path: str
    fund_analysis_result: dict


# ============================================================
# 2ï¸âƒ£ LLM í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
# ============================================================
FUND_RECOMMENDATION_PROMPT_V4_KO = """
[Persona]
ë‹¹ì‹ ì€ 'ìš°ë¦¬ì€í–‰'ì˜ ìµœê³  í€ë“œ ì „ë¬¸ê°€(FundAgent)ì…ë‹ˆë‹¤.
ê¸ˆìœµ ì´ˆë³´ìì—ê²Œ ê°ê´€ì ì¸ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í€ë“œë¥¼ ì¶”ì²œí•˜ëŠ” ë° íŠ¹í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

[Core Logic]
- 'ìµœì¢…_ì¢…í•©í’ˆì§ˆì ìˆ˜'ëŠ” í€ë“œë§¤ë‹ˆì €ê°€ ê³¼ê±° 1~3ë…„ê°„ ì–¼ë§ˆë‚˜ ê¾¸ì¤€íˆ "ìœ„í—˜ ëŒ€ë¹„ ìì‚°ì„ ì˜ ìš´ìš©í–ˆëŠ”ê°€"ë¥¼ í‰ê°€í•œ 'ìš´ìš© ê¸°ìˆ  ì„±ì í‘œ'ì…ë‹ˆë‹¤.
- ì´ ì ìˆ˜ê°€ ë†’ë‹¤ëŠ” ê²ƒì€ ë³€ë™ì„±, ë³´ìˆ˜, ê·œëª¨ ë“±ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•  ë•Œ 'í˜„ì¬' ê°€ì¥ ì˜ ìš´ìš©ë˜ê³  ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
- ê³¼ê±° ì„±ê³¼ê°€ ë¯¸ë˜ë¥¼ ë³´ì¥í•˜ì§„ ì•Šì§€ë§Œ, ì¢‹ì€ ì„±ì í‘œë¥¼ ë°›ì€ í€ë“œê°€ ì•ìœ¼ë¡œë„ ì˜í•  í™•ë¥ ì´ ë†’ë‹¤ëŠ” ë…¼ë¦¬ë¡œ ê³ ê°ì„ ì„¤ë“í•©ë‹ˆë‹¤.

[Task]
1. [ê³ ê° ì •ë³´]ì™€ Pythonì´ ì„ ë³„í•œ [ì¶”ì²œ í€ë“œ ëª©ë¡]ì„ ì…ë ¥ë°›ìŠµë‹ˆë‹¤.
   (ì´ ëª©ë¡ì€ ê³ ê° ì„±í–¥ì— ë§ëŠ” *ê° ìœ„í—˜ ë“±ê¸‰ë³„*ë¡œ ìµœëŒ€ 2ê°œì”© ì„ ë³„ëœ ê²°ê³¼ì…ë‹ˆë‹¤.)
2. ê° í€ë“œëŠ” 'ì¢…í•© ì ìˆ˜'ì™€ í•¨ê»˜ ê³ ê°ì´ ì´í•´í•˜ê¸° ì‰¬ìš´ 4ê°€ì§€ **[í•µì‹¬_ê·¼ê±°_ì§€í‘œ]**ë¥¼ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤.
3. ê° í€ë“œì˜ [í•µì‹¬_ê·¼ê±°_ì§€í‘œ]ë¥¼ í™œìš©í•˜ì—¬, ì´ í€ë“œê°€ ì™œ 'ì¢…í•©í’ˆì§ˆì ìˆ˜'ê°€ ë†’ì€ì§€(ì™œ ì˜ ìš´ìš©ë˜ê³  ìˆëŠ”ì§€) [Core Logic]ì— ê¸°ë°˜í•œ **"ì¶”ì²œ_ì´ìœ "**ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
4. (ì¤‘ìš”) 'ì¶”ì²œ_ì´ìœ 'ëŠ” ë°˜ë“œì‹œ **êµ¬ì²´ì ì¸ ê·¼ê±°(ìˆ«ì)ë¥¼ 1~2ê°œ í¬í•¨**í•˜ì—¬ ì´ˆë³´ìê°€ ì‹ ë¢°í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±í•©ë‹ˆë‹¤.
5. (ì¤‘ìš”) ì…ë ¥ë°›ì€ ìƒí’ˆ ëª©ë¡ êµ¬ì¡°ì— 'ì¶”ì²œ_ì´ìœ ' í‚¤(key)ë§Œ ì¶”ê°€í•˜ì—¬ ì „ì²´ JSONì„ [Output Format]ì— ë§ì¶° ë°˜í™˜í•©ë‹ˆë‹¤.

[Inputs]
ê³ ê° ì •ë³´:
- user_id: {user_id}
- ë¦¬ìŠ¤í¬ ì„±í–¥: {user_risk_level}

ì¶”ì²œ í€ë“œ ëª©ë¡ (Pythonì´ ê³ ê° ì„±í–¥ ë° ë“±ê¸‰ë³„ Top 2 ê¸°ì¤€ìœ¼ë¡œ 1ì°¨ í•„í„°ë§ ì™„ë£Œ):
{input_top_n_funds}

[Output Format ì˜ˆì‹œ] (ëª¨ë“  í‚¤ëŠ” ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±)
(ì˜ˆì‹œ: 'ì ê·¹íˆ¬ìí˜•' ê³ ê°ì´ 1, 2ë“±ê¸‰ì—ì„œ 2ê°œì”© ì¶”ì²œë°›ì€ ê²½ìš°)
<analysis_result>
{{
  "ì¶”ì²œ_í€ë“œ_ëª©ë¡": [
    {{
      "í€ë“œëª…": "(1ë“±ê¸‰) ì‚¼ì„± ê¸€ë¡œë²Œë°˜ë„ì²´ì¦ê¶Œìíˆ¬ìì‹ íƒUH[ì£¼ì‹]_S-P",
      "ìœ„í—˜ë“±ê¸‰": "ë§¤ìš° ë†’ì€ ìœ„í—˜",
      "ìƒí’ˆ_ì„¤ëª…": "ì´ íˆ¬ìì‹ íƒì€ ë°˜ë„ì²´ ê´€ë ¨ ê¸€ë¡œë²Œ ì£¼ì‹ì— íˆ¬ìí•˜ì—¬...",
      "ìµœì¢…_ì¢…í•©í’ˆì§ˆì ìˆ˜": 0.95,
      "ì„±ê³¼_ì ìˆ˜": 1.10,
      "ì•ˆì •ì„±_ì ìˆ˜": 0.80,
      "í•µì‹¬_ê·¼ê±°_ì§€í‘œ": {{
        "1ë…„_ìˆ˜ìµë¥ ": 15.2,
        "ìµœëŒ€_ì†ì‹¤_ë‚™í­": -8.5,
        "ì´ë³´ìˆ˜": 0.45,
        "ìš´ìš©_ê·œëª¨(ì–µ)": 1200.0
      }},
      "ì¶”ì²œ_ì´ìœ ": "ê³ ê°ë‹˜ì˜ 'ì ê·¹íˆ¬ìí˜•' ì„±í–¥ì— ë§ëŠ” 'ë§¤ìš° ë†’ì€ ìœ„í—˜(1ë“±ê¸‰)' ìƒí’ˆ ì¤‘ ì¢…í•© í’ˆì§ˆ 1ìœ„ì…ë‹ˆë‹¤. **ìµœê·¼ 1ë…„ ìˆ˜ìµë¥ ì´ 15.2%**ë¡œ ìš°ìˆ˜í•˜ê³  **ì´ë³´ìˆ˜ë„ 0.45%**ë¡œ ë‚®ì•„ íš¨ìœ¨ì ì¸ ìš´ìš© ì„±ì í‘œë¥¼ ë³´ì—¬ì£¼ê³  ìˆìŠµë‹ˆë‹¤."
    }},
    {{
      "í€ë“œëª…": "(1ë“±ê¸‰) KBìŠ¤íƒ€ ê¸€ë¡œë²ŒAI&ë°˜ë„ì²´ì¦ê¶Œíˆ¬ìì‹ íƒ(ì£¼ì‹) S-P",
      "ìœ„í—˜ë“±ê¸‰": "ë§¤ìš° ë†’ì€ ìœ„í—˜",
      "ìƒí’ˆ_ì„¤ëª…": "AI ë° ë°˜ë„ì²´ ê´€ë ¨ ê¸€ë¡œë²Œ ì£¼ì‹ì— íˆ¬ìí•©ë‹ˆë‹¤...",
      "ìµœì¢…_ì¢…í•©í’ˆì§ˆì ìˆ˜": 0.92,
      "ì„±ê³¼_ì ìˆ˜": 1.05,
      "ì•ˆì •ì„±_ì ìˆ˜": 0.79,
      "í•µì‹¬_ê·¼ê±°_ì§€í‘œ": {{
        "1ë…„_ìˆ˜ìµë¥ ": 14.8,
        "ìµœëŒ€_ì†ì‹¤_ë‚™í­": -9.1,
        "ì´ë³´ìˆ˜": 0.50,
        "ìš´ìš©_ê·œëª¨(ì–µ)": 800.0
      }},
      "ì¶”ì²œ_ì´ìœ ": "'ë§¤ìš° ë†’ì€ ìœ„í—˜(1ë“±ê¸‰)' ìƒí’ˆ ì¤‘ ì¢…í•© í’ˆì§ˆ 2ìœ„ í€ë“œì…ë‹ˆë‹¤. **14.8%ì˜ ë†’ì€ 1ë…„ ìˆ˜ìµë¥ ** ëŒ€ë¹„ 'ìµœëŒ€ ì†ì‹¤ ë‚™í­' ê´€ë¦¬ê°€ ìš°ìˆ˜í•˜ì—¬ ì¢‹ì€ 'ìš´ìš© ì„±ì í‘œ'ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤."
    }},
    {{
      "í€ë“œëª…": "(2ë“±ê¸‰) ë¯¸ë˜ì—ì…‹ ë¯¸êµ­S&P500ì¸ë±ìŠ¤ì¦ê¶Œìíˆ¬ìì‹ íƒ(ì£¼ì‹)",
      "ìœ„í—˜ë“±ê¸‰": "ë†’ì€ ìœ„í—˜",
      "ìƒí’ˆ_ì„¤ëª…": "ë¯¸êµ­ S&P500 ì§€ìˆ˜ë¥¼ ì¶”ì¢…í•˜ëŠ” ì¸ë±ìŠ¤ í€ë“œì…ë‹ˆë‹¤...",
      "ìµœì¢…_ì¢…í•©í’ˆì§ˆì ìˆ˜": 0.89,
      "ì„±ê³¼_ì ìˆ˜": 0.85,
      "ì•ˆì •ì„±_ì ìˆ˜": 0.93,
      "í•µì‹¬_ê·¼ê±°_ì§€í‘œ": {{
        "1ë…„_ìˆ˜ìµë¥ ": 12.1,
        "ìµœëŒ€_ì†ì‹¤_ë‚™í­": -7.2,
        "ì´ë³´ìˆ˜": 0.25,
        "ìš´ìš©_ê·œëª¨(ì–µ)": 3500.0
      }},
      "ì¶”ì²œ_ì´ìœ ": "ê³ ê°ë‹˜ ì„±í–¥ì— ë§ëŠ” 'ë†’ì€ ìœ„í—˜(2ë“±ê¸‰)' ìƒí’ˆ ì¤‘ 1ìœ„ì…ë‹ˆë‹¤. **ì´ 3,500ì–µ ì›**ì˜ ì•ˆì •ì ì¸ ìš´ìš© ê·œëª¨ì™€ **0.25%**ë¼ëŠ” ë§¤ìš° ë‚®ì€ ë³´ìˆ˜ê°€ í° ì¥ì ì…ë‹ˆë‹¤."
    }},
    {{
      "í€ë“œëª…": "(2ë“±ê¸‰) í•œêµ­íˆ¬ì ë¯¸êµ­S&P500ì¦ê¶Œíˆ¬ìì‹ íƒ(ì£¼ì‹)(C-Pe)",
      "ìœ„í—˜ë“±ê¸‰": "ë†’ì€ ìœ„í—˜",
      "ìƒí’ˆ_ì„¤ëª…": "S&P500 ì§€ìˆ˜ë¥¼ ì¶”ì¢…í•˜ë©° í™˜í—¤ì§€ë¥¼ ì‹¤í–‰í•˜ëŠ”...",
      "ìµœì¢…_ì¢…í•©í’ˆì§ˆì ìˆ˜": 0.88,
      "ì„±ê³¼_ì ìˆ˜": 0.84,
      "ì•ˆì •ì„±_ì ìˆ˜": 0.92,
      "í•µì‹¬_ê·¼ê±°_ì§€í‘œ": {{
        "1ë…„_ìˆ˜ìµë¥ ": 11.9,
        "ìµœëŒ€_ì†ì‹¤_ë‚™í­": -7.0,
        "ì´ë³´ìˆ˜": 0.30,
        "ìš´ìš©_ê·œëª¨(ì–µ)": 2100.0
      }},
      "ì¶”ì²œ_ì´ìœ ": "'ë†’ì€ ìœ„í—˜(2ë“±ê¸‰)' ìƒí’ˆ ì¤‘ 2ìœ„ í€ë“œì…ë‹ˆë‹¤. **ì—° 0.30%ì˜ ë‚®ì€ ë³´ìˆ˜**ì™€ ì•ˆì •ì ì¸ 'ìµœëŒ€ ì†ì‹¤ ë‚™í­' ê´€ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê¾¸ì¤€íˆ ìš°ìˆ˜í•œ ì¢…í•© í’ˆì§ˆ ì ìˆ˜ë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤."
    }}
  ]
}}
</analysis_result>
"""


# ============================================================
# 3ï¸âƒ£ FundAgentNode í´ë˜ìŠ¤ ì •ì˜
# ============================================================
class FundAgentNode:
    def __init__(self):
        print("--- FundAgentNode ì´ˆê¸°í™” ---")
        try:
            self.llm = ChatOllama(model="qwen3:8b")
            print("--- âœ… ë¡œì»¬ Ollama ëª¨ë¸(qwen3:8b) ë¡œë“œ ì„±ê³µ ---")
        except Exception as e:
            print(f"âŒ Ollama ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: {e}")
            print("âš ï¸ 'ollama pull qwen3:8b' ëª…ë ¹ìœ¼ë¡œ ëª¨ë¸ì„ ì„¤ì¹˜í•˜ì„¸ìš”.")
            exit()

        # í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ê³¼ ì²´ì¸ êµ¬ì„±
        self.prompt_template = ChatPromptTemplate.from_template(FUND_ANALYST_PROMPT)
        self.chain = self.prompt_template | self.llm | StrOutputParser() | self._parse_analysis_result
        print("--- âœ… LLM ì²´ì¸ êµ¬ì„± ì™„ë£Œ ---")

    # ----------------------------------------------------------
    # ğŸ”¹ LLM ê²°ê³¼ íŒŒì‹±
    # ----------------------------------------------------------
    def _parse_analysis_result(self, llm_output: str):
        try:
            if "```json" in llm_output:
                result_str = llm_output.split("```json")[1].split("```")[0].strip()
            elif "'''json" in llm_output:
                result_str = llm_output.split("'''json")[1].split("'''")[0].strip()
            elif "<analysis_result>" in llm_output:
                result_str = llm_output.split("<analysis_result>")[1].split("</analysis_result>")[0].strip()
            elif llm_output.strip().startswith("{") and llm_output.strip().endswith("}"):
                result_str = llm_output.strip()
            else:
                raise ValueError("LLMì˜ ì¶œë ¥ì—ì„œ ìœ íš¨í•œ JSON í˜•ì‹ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return json.loads(result_str)
        except Exception as e:
            print(f"âš ï¸ íŒŒì‹± ì‹¤íŒ¨: {e}")
            print(f"LLM ì›ë³¸ ì¶œë ¥:\n{llm_output}")
            return {"error": "ë¶„ì„ ê²°ê³¼ íŒŒì‹± ì‹¤íŒ¨"}

    # ----------------------------------------------------------
    # ğŸ”¹ LangGraph ë…¸ë“œ ì‹¤í–‰ í•¨ìˆ˜
    # ----------------------------------------------------------
    def run(self, state: FundAgentState):
        print("\n--- [ë…¸ë“œ ì‹œì‘] 'í€ë“œ ë¶„ì„ ë…¸ë“œ' ì‹¤í–‰ ---")

        # âœ… ì•ˆì „í•˜ê²Œ íŒŒì¼ ê²½ë¡œ í™•ì¸ ë° ê¸°ë³¸ ê²½ë¡œ ì„¤ì •
        file_path = state.get("fund_data_path")
        if not file_path or not os.path.exists(file_path):
            print("âš ï¸ fund_data_pathê°€ ì „ë‹¬ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
            file_path = "/Users/yoodongseok/Desktop/WooriAgent/agent/fund_data.json"

        # âœ… íŒŒì¼ ë¡œë“œ
        try:
            with open(file_path, "r", encoding="utf-8") as f:
                raw_fund_data = json.load(f)
            print(f"--- âœ… í€ë“œ ë°ì´í„° ë¡œë“œ ì„±ê³µ: {file_path} ---")
        except FileNotFoundError:
            print(f"âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {file_path}")
            return {"fund_analysis_result": {"error": f"File not found: {file_path}"}}
        except json.JSONDecodeError:
            print(f"âŒ JSON í˜•ì‹ ì˜¤ë¥˜: {file_path}")
            return {"fund_analysis_result": {"error": f"Invalid JSON: {file_path}"}}
        except Exception as e:
            print(f"âŒ íŒŒì¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return {"fund_analysis_result": {"error": str(e)}}

        # âœ… LLM ì…ë ¥ ë°ì´í„° ì¤€ë¹„
        print("--- í€ë“œ ë°ì´í„° ë¶„ì„ ì‹œì‘ ---")
        fund_data_str = json.dumps(raw_fund_data, indent=2, ensure_ascii=False)

        # âœ… LLM ì²´ì¸ ì‹¤í–‰
        analysis_result = self.chain.invoke({"input_data": fund_data_str})

        print("--- [ë…¸ë“œ ì¢…ë£Œ] 'í€ë“œ ë¶„ì„ ë…¸ë“œ' ì™„ë£Œ ---")
        return {"fund_analysis_result": analysis_result}


# ============================================================
# 4ï¸âƒ£ VS Code ë¡œì»¬ ì‹¤í–‰ (ë‹¨ë… í…ŒìŠ¤íŠ¸ìš©)
# ============================================================
if __name__ == "__main__":
    fund_agent_node = FundAgentNode()

    # ê·¸ë˜í”„ êµ¬ì„±
    workflow = StateGraph(FundAgentState)
    workflow.add_node("analyze_funds", fund_agent_node.run)
    workflow.set_entry_point("analyze_funds")
    workflow.add_edge("analyze_funds", END)
    app = workflow.compile()

    # ì ˆëŒ€ê²½ë¡œ ì§€ì • âœ…
    file_path_to_run = "/Users/yoodongseok/Desktop/WooriAgent/fund_data.json"

    # ì´ˆê¸° ìƒíƒœ ì •ì˜ âœ…
    initial_state = {
        "fund_data_path": file_path_to_run,
        "fund_analysis_result": {},
    }

    print("\n--- ğŸ (LangGraph) í€ë“œ ë¶„ì„ ê·¸ë˜í”„ ì‹¤í–‰ ì‹œì‘ ğŸ ---")
    print(f"ğŸ”¹ ì…ë ¥ ê²½ë¡œ: {file_path_to_run}")

    # ê·¸ë˜í”„ ì‹¤í–‰
    final_state = app.invoke(initial_state)

    print("\n--- ğŸ (LangGraph) ê·¸ë˜í”„ ì‹¤í–‰ ì™„ë£Œ ğŸ ---")
    print(json.dumps(final_state["fund_analysis_result"], indent=2, ensure_ascii=False))
